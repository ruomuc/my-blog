---
title: elasticsearch初踩坑
categories:
  - 数据库
tags:
  - elasticsearch
date: 2020-07-04 22:41:45
updated: 2020-07-04 22:41:45

---
大概说一下前段时间用`elasticsearch`遇到的几个坑

`es`版本为`7.7.1`

#### 原始需求

千万级会员，三个条件模糊搜索（左匹配），使用`mysql`大概要30多秒，因为体验太差所以考虑用`es`做优化。

实际上，这种需求并不是`es`主要针对的场景，但是用也可以用，效果也不错，同样的搜索条件`0-3s`。因为最终结果会比`mysql`少一些数据，所以在准确率`95-99%`之间，在我们可以接受的范围之内。

#### 遇到坑和问题

##### 文档不准确

`es`版本更新快，官网的入门教程还是基于`es2.0`写的，用的时候遇到许多语法不支持，所以只能去看对应版本英文文档。包括网上的一些教程、博文的版本都各不相同。

解决方案：

没有办法。。。更新太快导致官放教程都没维护，入门的话就只能对比着对应版本的英文文档看了，只能多踩一些坑。

##### 索引的映射类型`type`失效

官方解释：

`在Elasticsearch6.0.0或者或者更新版本中创建的索引只会包含一个映射类型(mappingtype). 在5.x中创建的具有多个映射类型的索引在Elasticsearch6.x中依然会正常工作。在Elasticsearch7.0.0中，映射类型将会被完全移除。`

解决方案：

创建索引不指定`type`，使用默认的就行，这个字段现在已经没有任何作用。

##### 索引的字段的`string`类型

在ElasticSearch 5.x 之后，字符串类型有了重大改动，移除了String类型，而拆分成了两个新类型`keyword`和`text`。

text类型：

- 会进行分词，分词后建立索引。【比如：对于‘佟永硕’，ik分词器的smart分词会自动将其分成佟、永、硕三个字符进行建立索引，所以单字符搜索可以搜索到，而比如‘永硕’则搜索不到】

- 支持模糊查询，支持准确查询。

- 不支持聚合查询

keyword类型：

- 不分词，直接建立索引。【依据此特点，可以使用keyword类型+wildcardQuery（通配查询）实现类似sql的like查询（模糊搜索）】
- 支持模糊查询，支持准确查询。
- 支持聚合查询。

如果你是跟着教程使用`string`的字段类型创建的索引，他会自动变为`text`，而根据我的需求，我需要的其实是`keyword`类型的字段，所以前几次数据总是很奇怪，因为被分词了。
<!--more-->
##### 分页

`elasticsearch`在分页上面可以说是极其不擅长了。。。

`es`的分页有两种方案：

- 搜索时指定`from`和`size`属性。假设每页十条数据我需要第十页的数据，即91-100。我会先查出前100条数据，把91-100条切出来，返回。
- `scroll`滚动的方式，有点像游标，第一次查询后，返回一个`scroll_id`，你用id去进行下一次查询，每次返回固定长度的数据。**适合用于下来刷新这种连续翻页的场景。**

这两个方案我都无法接受，事实上我使用`scroll`的方式，手动写了一个分页函数，比如要取100页的数据，就递归滚动100次，试了一下巨慢无比，没有意义。。。

解决方案：

改需求。。。没有错，事实上模糊搜索没有人在乎最后一页的数据，比如说百度谷歌，一般人前十页都不会翻完。于是乎，我们使用`from size`的方式，永远只返回前1000数据用于分页。

##### 其它

数据初始化： 我直接分片查的`mysql`格式化后使用`bulk`这个`api`直接导入`es`。一片1w数据，1200多万2个小时左右。事实上有更好的方案。

数据更新：我们有定时器服务，每一段时间拿到有更新的会员数据，覆盖插入进redis，因为我们`es`数据的`id`用的是会员卡号，保证唯一。

`es`和`kibana`的部署： 开发环境的用`dokcer`就好了，这个琢磨一下应该不复杂。。