---
title: mysql之事务
categories:
  - 数据库
tags:
  - mysql
  - 事务
date: 2019-06-26 18:52:02
updated: 2021-07-14 18:29:36
cover: https://proxy.qnoss.seeln.com/images/foCyHXt-black-hole-wallpaper.jpg
---

本文于 2021年07月14日19:39:57 重新整理。。。之前写的自己都有点看不下去。

#### 什么是事务

简单来说，事务就是要保证一组数据的操作，要么全部成功，要么全部失败。

在 mysql 中，事务是由引擎实现的，比如 InnoDB 支持事务，而 MyISAM 就不支持事务。

<!--more-->

#### 事务四大特性

常说的 ACID 就是事务的四大特性：

- **原子性（Atomicity）**：事务是一个原子操作，要么全部成功，要么全部失败。
- **一致性 （Consistency）**：事务要保证数据库整体数据的完整性和业务的数据的一致性，事务成功提交整体数据修改，事务错误则回滚到数据回到原来的状态。
- **隔离性（Isolation）**：并行执行的事务之间互不干扰，隔离开来。(这里涉及到隔离级别）
- **持久性（Atomicity）**：事务成功提交后，只要修改的数据都会进行持久化，不会因为异常、宕机而造成数据错误或丢失。

#### 事务的隔离级别

事务为什么要隔离级别呢，因为数据你**隔离的越严密**，那么**效率**就越低，所以这里需要根据业务选择，使二者有一个平衡点。

<br>

隔离级别：

- 读未提交：一个事务还未提交时，它的变更就能被其它事务看到。
- 读已提交：一个事务提交后，它做的变更才会被其它事务看到。
- 可重复读：一个事务执行过程中看到的数据，总是跟这个事务在启动时看到的数据是一致的。
- 串行化：这个是效率做低的，对同一行记录操作时，会加“读锁”或“写锁”，后访问的事务必须等前面的事务完成。

这是极客时间课程里的一张图：

<img src="https://static001.geekbang.org/resource/image/7d/f8/7dea45932a6b722eb069d2264d0066f8.png" alt="img" style="zoom:25%;" />

- 若隔离级别是“读未提交”， 则 V1 的值就是 2。这时候事务 B 虽然还没有提交，但是结果已经被 A 看到了。因此，V2、V3 也都是 2。
- 若隔离级别是“读已提交”，则 V1 是 1，V2 的值是 2。事务 B 的更新在提交后才能被 A 看到。所以， V3 的值也是 2。
- 若隔离级别是“可重复读”，则 V1、V2 是 1，V3 是 2。之所以 V2 还是 1，遵循的就是这个要求：事务在执行期间看到的数据前后必须是一致的。
- 若隔离级别是“串行化”，则在事务 B 执行“将 1 改成 2”的时候，会被锁住。直到事务 A 提交后，事务 B 才可以继续执行。所以从 A 的角度看， V1、V2 值是 1，V3 的值是 2。

ps: 我觉得这个描述非常好理解了，引用自极客时间。

#### 事务隔离的实现

InnoDB 使用 undo log 实现事务，每条记录在更新时都会同时记录一条回滚操作，通过回滚操作就可以得到前一个状态的值。

undo log 是一个逻辑日志，记录的是操作过程，并且是逆向的操作过程。

比如 你 insert.. 就会记录一个 delete... 的操作。





ps: 这里主要是看到之前写过一篇事务的文章，看不下去就重新整理了一点。没有深入和扩展开来。这一片就这样吧



参考链接：

- 极客时间，《mysql实战45讲》
